<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Think and Grow Rich: Interactive Workshop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F8F7F4; /* Softer off-white */
        }
        h1, h2, h3, h4, .font-serif {
            font-family: 'Lora', serif;
        }
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .content-section.active {
            display: block;
        }
        .sidebar-link.active {
            background-color: #D6A354;
            color: #ffffff;
            font-weight: 600;
        }
        .sidebar-link.locked {
            color: #a8a29e;
            cursor: not-allowed;
            background-color: #f5f5f4;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 40;
            animation: fadeIn 0.3s;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            animation: fadeIn 0.3s;
        }
        #login-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background-color: #F8F7F4;
            z-index: 100;
        }
        .prose strong { color: #A855F7; }
        .prose blockquote { 
            border-left-color: #D6A354; 
            background-color: #FDFBF7;
            padding: 1rem;
            font-style: italic;
        }
        .task-item.completed span {
            text-decoration: line-through;
            color: #9ca3af;
        }
        .principle-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .principle-card.locked {
            filter: grayscale(80%);
            opacity: 0.6;
            cursor: not-allowed;
        }
        .principle-card .completion-check {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #16a34a;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.5);
            transition: opacity 0.3s, transform 0.3s;
        }
         .principle-card.completed .completion-check {
            opacity: 1;
            transform: scale(1);
        }
        .nav-link.active {
            background-color: #D6A354;
            color: white;
        }
        /* New Carousel Styles */
        #dashboard-carousel-container {
            position: relative;
            overflow: hidden;
        }
        #dashboard-carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            min-width: 100%;
            box-sizing: border-box;
            padding: 1rem;
        }
        .carousel-slide.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .carousel-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 10;
        }
        .carousel-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .carousel-dot {
            width: 12px;
            height: 12px;
            background-color: #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .carousel-dot.active {
            background-color: #D6A354;
        }
        .carousel-dot.locked {
            background-color: #e5e7eb;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">
    <div id="login-overlay" class="flex items-center justify-center p-4">
        <div class="text-center bg-white p-8 sm:p-12 rounded-lg shadow-2xl max-w-md w-full">
            <h2 class="text-3xl font-bold text-stone-800 mb-4">Welcome to Your Workshop</h2>
            <p class="text-lg text-stone-600 mb-8">Sign in with Google to save your progress and build your legacy.</p>
            <button id="google-login-btn" class="inline-flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.089,5.571l6.19,5.238C44.572,36.833,48,31.145,48,24C48,22.659,47.862,21.35,47.611,20.083z"></path></svg>
                Sign in with Google
            </button>
        </div>
    </div>
    
    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-0 z-30">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-stone-700">Think & Grow Rich</h1>
                    </div>
                    <div class="hidden md:block">
                        <div id="main-nav" class="ml-10 flex items-baseline space-x-1">
                            </div>
                    </div>
                     <div id="user-area" class="flex items-center gap-4">
                          <div id="status-indicator" class="text-sm text-gray-500 opacity-0">Connecting...</div>
                          <button id="sign-out-btn" class="hidden nav-button bg-stone-200 hover:bg-stone-300 text-stone-800 font-bold py-2 px-4 rounded-lg transition duration-300">Sign Out</button>
                     </div>
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-stone-600 hover:text-stone-800 hover:bg-stone-200 focus:outline-none">
                            <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </nav>
            <div id="mobile-menu" class="md:hidden hidden">
                <div id="mobile-nav" class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    </div>
            </div>
        </header>

        <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="home" class="content-section">
                <div class="text-center bg-white p-8 rounded-lg shadow-lg">
                    <h2 class="text-4xl font-bold text-stone-800 mb-4">"Whatever the Mind Can Conceive and Believe, It Can Achieve."</h2>
                    <p class="text-lg text-stone-600 max-w-3xl mx-auto mb-6">Welcome to the interactive workshop for Napoleon Hill's timeless classic, *Think and Grow Rich*. This is not just a book to be read; it's a philosophy to be lived. This digital experience is designed to help you move beyond passive reading into active practice. Here, you will find tools and exercises to help you define your desires, build unshakeable faith, and create actionable plans to transform your dreams into reality.</p>
                    <p class="text-lg text-stone-600 max-w-3xl mx-auto mb-8">Begin your journey by exploring the 13 Principles, diagnose your mental obstacles in The Workshop, and build your personal success plan in your Dashboard. Your journey to riches—in wealth, happiness, and spiritual satisfaction—starts now.</p>
                    <button class="nav-button bg-amber-400 hover:bg-amber-500 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5" data-target="principles-hub">Start the Journey: Explore the 13 Principles</button>
                </div>
            </div>

            <div id="dashboard" class="content-section">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                     <h2 id="dashboard-greeting" class="text-3xl font-bold text-stone-800 mb-4 sm:mb-0">My Dashboard</h2>
                     <div id="dashboard-progress-summary" class="text-right"></div>
                </div>

                <div id="dashboard-carousel-container" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                    <div class="relative">
                        <div id="dashboard-carousel-track" class="flex">
                            </div>
                        <button id="carousel-prev-btn" class="carousel-button left-0 sm:-left-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                        </button>
                        <button id="carousel-next-btn" class="carousel-button right-0 sm:-right-4">
                           <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="carousel-dots" class="flex justify-center items-center mt-6 space-x-3">
                        </div>
                </div>
            </div>

            <div id="principles-hub" class="content-section">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-stone-800">The 13 Principles of Achievement</h2>
                     <p class="mt-4 text-lg text-stone-600 max-w-3xl mx-auto">This is the core of Napoleon Hill's philosophy. Each principle is a step toward mastering your mind and directing it towards the attainment of your goals. Explore each principle to understand its meaning and engage with the interactive exercises to apply it to your own life. Click on a card to begin.</p>
                </div>
                <div id="principles-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
            </div>
            
            <div id="principles-detail-view" class="content-section">
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="w-full lg:w-1/4 xl:w-1/5">
                        <h3 class="text-xl font-bold mb-4">The 13 Principles</h3>
                        <nav id="principles-sidebar" class="space-y-2">
                        </nav>
                    </aside>
                    <div id="principle-content-area" class="w-full lg:w-3/4 xl:w-4/5 bg-white p-6 sm:p-8 rounded-lg shadow-lg">
                    </div>
                </div>
            </div>
            
            <div id="workshop" class="content-section">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-stone-800">The Mindset Gymnasium</h2>
                     <p class="mt-4 text-lg text-stone-600 max-w-3xl mx-auto">Success is an inside job. Fortify your mind against the internal enemies of failure with these mental workouts.</p>
                </div>
                <div id="workshop-tools" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    </div>
            </div>
        </main>
    </div>

    <div id="desire-modal-backdrop" class="modal-backdrop"></div>
    <div id="desire-modal" class="modal bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full">
        <h3 class="text-2xl font-bold mb-4">The Six Steps to Riches</h3>
        <p class="text-sm text-stone-600 mb-6">Follow this formula to transmute your desire for riches into its financial equivalent. Be specific and be bold.</p>
        <form id="desire-form">
            <div class="mb-4">
                <label for="desire-amount" class="block text-sm font-medium text-stone-700">1. The exact amount of money I desire is:</label>
                <input type="text" id="desire-amount" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50" placeholder="$1,000,000">
            </div>
            <div class="mb-4">
                <label for="desire-give" class="block text-sm font-medium text-stone-700">2. What I intend to give in return:</label>
                <textarea id="desire-give" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50" placeholder="My full effort in building the most innovative marketing agency..."></textarea>
            </div>
            <div class="mb-4">
                <label for="desire-date" class="block text-sm font-medium text-stone-700">3. A definite date for its acquisition:</label>
                <input type="date" id="desire-date" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
                <label for="desire-plan" class="block text-sm font-medium text-stone-700">4. My clear, definite plan to achieve it:</label>
                <textarea id="desire-plan" rows="4" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50" placeholder="First, I will... Second, I will..."></textarea>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" id="close-desire-modal" class="px-4 py-2 bg-stone-200 text-stone-800 rounded-lg hover:bg-stone-300">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600">Save Statement</button>
            </div>
        </form>
    </div>
    
    <div id="reset-confirm-modal" class="modal bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
        <h3 class="text-2xl font-bold mb-4">Reset Progress?</h3>
        <p class="text-sm text-stone-600 mb-6">This will clear your saved work for this principle and all subsequent principles. Are you sure you want to continue?</p>
        <div class="flex justify-end gap-4 mt-6">
             <button id="cancel-reset-btn" class="px-4 py-2 bg-stone-200 text-stone-800 rounded-lg hover:bg-stone-300">Cancel</button>
             <button id="confirm-reset-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Yes, Reset</button>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Main App Logic
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase and App State
            let db, auth, userId, userData;
            let isAuthReady = false;
            let progressChartInstance = null;
            let currentCarouselIndex = 0; // State for the new dashboard carousel

            const appData = {
                 principles: [
                     { id: 'desire', name: 'Desire', tagline: 'The Turning Point of All Achievement' },
                     { id: 'faith', name: 'Faith', tagline: 'Visualizing and Believing in Attainment' },
                     { id: 'auto-suggestion', name: 'Auto-Suggestion', tagline: 'Influencing the Subconscious Mind' },
                     { id: 'specialized-knowledge', name: 'Specialized Knowledge', tagline: 'Personal Experiences or Observations' },
                     { id: 'imagination', name: 'Imagination', tagline: 'The Workshop of the Mind' },
                     { id: 'organized-planning', name: 'Organized Planning', tagline: 'Crystallization of Desire into Action' },
                     { id: 'decision', name: 'Decision', tagline: 'The Mastery of Procrastination' },
                     { id: 'persistence', name: 'Persistence', tagline: 'The Sustained Effort to Induce Faith' },
                     { id: 'master-mind', name: 'Power of the Master Mind', tagline: 'The Driving Force' },
                     { id: 'sex-transmutation', name: 'Sex Transmutation', tagline: 'The Mystery of Converting Energy' },
                     { id: 'subconscious-mind', name: 'The Subconscious Mind', tagline: 'The Connecting Link' },
                     { id: 'brain', name: 'The Brain', tagline: 'A Broadcasting and Receiving Station' },
                     { id: 'sixth-sense', name: 'The Sixth Sense', tagline: 'The Door to the Temple of Wisdom' }
                 ],
                 content: [
                     {
                         id: 'desire',
                         title: 'Desire: The Turning Point of All Achievement',
                         summary: `Every great achievement starts with a burning, definite desire, not a mere wish or a hope. It is an all-consuming obsession. The story of Edwin C. Barnes, who "thought" his way into a partnership with Thomas Edison, perfectly illustrates this. He arrived at Edison's lab a penniless "tramp," but in his mind, he was already Edison's partner. He didn't say "I will work for Edison," he said "I will work *with* Edison." His burning desire was the one asset he possessed, and it was enough. To harness this principle, you must transform your vague wants into a clear, definite purpose and back it with persistence until it becomes a reality. <blockquote>"The starting point of all achievement is DESIRE. Keep this constantly in mind. Weak desires bring weak results, just as a small amount of fire makes a small amount of heat."</blockquote>`,
                         practice: {
                             title: "Practice: The Six-Step Formula",
                             description: "Napoleon Hill provides a practical, six-step method for transmuting desire into its financial equivalent. This is not a magic trick; it's a psychological tool to crystallize your goal and burn it into your subconscious mind. Click the button below to begin this foundational exercise.",
                             buttonText: "Define My Desire",
                             action: 'openDesireModal'
                         }
                     },
                     {
                         id: 'faith',
                         title: 'Faith: Visualizing and Believing in Attainment',
                         summary: `Faith is a state of mind that you can cultivate through auto-suggestion. It is the "head chemist" of the mind, which, when blended with thought, connects you with Infinite Intelligence. Faith is the basis of all "miracles" and mysteries that cannot be analyzed by the rules of science. It's the vital element that gives power and life to your desire. You must act as if you already possess what you desire, and your subconscious mind will hand over a practical plan for acquiring it. The story of U.S. Steel's formation illustrates this. Charles M. Schwab's idea was not just a clever plan; it was infused with such powerful faith that it magnetized J.P. Morgan and created a billion-dollar corporation from an intangible thought. <blockquote>"FAITH is the eternal elixir which gives life, power, and action to the impulse of thought!"</blockquote>`,
                         practice: {
                             title: "Practice: The Self-Confidence Formula",
                             description: "To build faith, you must impress your subconscious mind with positive affirmations. Hill provides a five-step Self-Confidence Formula. Write out your own version of this formula below. Read it aloud once daily, and over time, it will develop in you the self-confidence to achieve any object.",
                             form: `
                                 <textarea id="faith-formula" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50" rows="8" placeholder="1. I know that I have the ability to achieve the object of my Definite Purpose in life... \n2. I realize the dominating thoughts of my mind will eventually reproduce themselves in outward, physical action...\n3. I know through the principle of auto-suggestion, any desire that I persistently hold in my mind will eventually seek expression... \n4. I have clearly written down a description of my definite chief aim in life...\n5. I fully realize that no wealth or position can long endure, unless built upon truth and justice..."></textarea>
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="saveFaith">Save & Continue</button>
                             `
                         }
                     },
                     {
                         id: 'auto-suggestion',
                         title: 'Auto-Suggestion: Influencing the Subconscious Mind',
                         summary: `Auto-suggestion is the control panel to your subconscious mind. It's the agency of communication between the conscious mind and the subconscious. Your subconscious mind is like a fertile garden; it will grow whatever seeds you plant, whether they are seeds of success or weeds of failure. Crucially, the subconscious only acts on thoughts that are mixed with emotion or feeling. Plain words have no effect. This is why you must read your written desire statement aloud daily, with feeling and emotion, seeing and feeling yourself already in possession of your goal. <blockquote>"Your subconscious mind recognizes and acts only upon thoughts which have been well-mixed with emotion or feeling."</blockquote>`,
                          practice: {
                             title: "Practice: The Visualization Vault",
                             description: "Your subconscious mind responds to emotion. Create a 'mental movie' of your success. In the space below, describe in vivid, emotional detail what it feels like to have already achieved your Definite Chief Aim. Read this daily to fuel your faith.",
                             form: `
                                 <textarea id="visualization-journal" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-amber-400 focus:ring focus:ring-amber-300 focus:ring-opacity-50" rows="8" placeholder="In my mind's eye, I see myself... I am filled with a feeling of..."></textarea>
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="auto-suggestion">Mark as Complete & Continue</button>
                             `
                         }
                     },
                     {
                         id: 'specialized-knowledge',
                         title: 'Specialized Knowledge: Personal Experiences or Observations',
                         summary: `General knowledge, no matter how great in quantity or variety, is of little use in accumulating money. Fortunes are created through specialized knowledge. This doesn't mean you must possess this knowledge yourself. Henry Ford was famously 'ignorant' of many technical details but surrounded himself with a Master Mind group who had the knowledge he needed. When sued for being an "ignorant pacifist," he challenged his critics by stating, "I have a row of electric push-buttons on my desk, and by pushing the right button, I can summon to my aid men who can answer any question I desire to ask concerning the business to which I am devoting most of my efforts. Now, will you kindly tell me, why I should clutter up my mind with general knowledge, for the purpose of being able to answer questions, when I have men around me who can supply any knowledge I require?" <blockquote>"Successful men, in all callings, never stop acquiring specialized knowledge related to their major purpose, business, or profession."</blockquote>`,
                         practice: {
                             title: "Practice: Knowledge Gap Analysis",
                             description: "Identify the specific knowledge you need to achieve your goal. Then, create a plan to acquire it. (Your entry here is for reflection and is not saved).",
                              form: `
                                 <label class="block text-sm font-medium text-stone-700">1. What specific skills or knowledge do I need for my goal?</label>
                                 <textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="3" placeholder="e.g., Digital marketing, public speaking, coding..."></textarea>
                                 <label class="block text-sm font-medium text-stone-700 mt-4">2. How will I acquire this knowledge? (Courses, books, mentors)</label>
                                 <textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="3" placeholder="e.g., Take a course on Coursera, read 3 books on sales, find a mentor..."></textarea>
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="specialized-knowledge">Mark as Complete & Continue</button>
                             `
                         }
                     },
                     {
                         id: 'imagination',
                         title: 'Imagination: The Workshop of the Mind',
                         summary: `The imagination is the workshop where all plans are created. Hill identifies two forms: <strong>Synthetic Imagination</strong>, which rearranges old concepts, ideas, or plans into new combinations, and <strong>Creative Imagination</strong>, which connects with Infinite Intelligence and is the source of "hunches" and inspiration. The story of Coca-Cola is a testament to imagination. The old country doctor who created the formula sold it for a pittance. It was Asa Candler's IDEA to mass-market it, an idea born of imagination, that became the "mysterious ingredient" that transformed a simple formula into a global empire. <blockquote>"Ideas are the beginning points of all fortunes. Ideas are products of the imagination."</blockquote>`,
                         practice: {
                             title: "Practice: Idea Sandbox",
                             description: "Exercise your imagination. Given your Definite Chief Aim, what is one new service or method you could create (Synthetic Imagination)? What is one 'impossible' idea that, if it worked, would change everything (Creative Imagination)?",
                             form: `
                                 <textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="5" placeholder="Let your mind run free. Don't censor any ideas..."></textarea>
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="imagination">Mark as Complete & Continue</button>
                             `
                         }
                     },
                     {
                         id: 'organized-planning',
                         title: 'Organized Planning: The Crystallization of Desire into Action',
                         summary: `You must create practical, definite plans for achieving your desire. It's crucial to ally yourself with a 'Master Mind' group. No plan is perfect. When a plan fails, it's a temporary defeat, not a permanent failure. Replace it with a new plan. A quitter never wins, and a winner never quits. Most great leaders began as intelligent followers. Before you can lead, you must demonstrate you can follow. To create effective plans, you must also cultivate the attributes of leadership. <blockquote>"An intelligent follower has many advantages, among them the OPPORTUNITY TO ACQUIRE KNOWLEDGE FROM HIS LEADER."</blockquote>`,
                         practice: {
                             title: "Practice: Leadership & Action Plan",
                             description: "Effective plans require leadership. First, rate yourself on the 11 major attributes of leadership below. Then, build your action plan. Adding at least one task will complete this step.",
                             form: `
                                 <h4 class="font-bold mb-2">Leadership Self-Assessment (1-10)</h4>
                                 <div id="leadership-sliders" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4"></div>
                                 <h4 class="font-bold mt-6 mb-2">Action Plan Builder</h4>
                                 <div id="action-plan-container"></div>
                                 <div class="flex mt-4">
                                     <input type="text" id="new-task-input" class="flex-grow rounded-l-md border-stone-300 shadow-sm" placeholder="Add a new action step...">
                                     <button id="add-task-btn" class="bg-purple-600 text-white px-4 rounded-r-md hover:bg-purple-700">Add</button>
                                 </div>
                                `
                         }
                     },
                    // ... [Content for other principles remains the same, just add a 'Mark as Complete' button to their practice forms]
                    {
                        id: 'decision',
                        title: 'Decision: The Mastery of Procrastination',
                        summary: `Lack of decision is a top cause of failure. Analysis of over 25,000 men and women who had experienced failure disclosed that lack of decision was near the head of the list of the 30 major causes of failure. People who succeed have the habit of reaching decisions promptly and of changing these decisions slowly, if at all. The world has the habit of making room for the person whose words and actions show they know where they are going. The 56 men who signed the Declaration of Independence made a monumental decision that could have cost them their lives, and in doing so, they birthed a nation. They knew that a principle as vital as freedom is worth dying for. <blockquote>"The value of a decision is in the courage required to render it."</blockquote>`,
                        practice: {
                            title: "Practice: Decision-Making Sprint",
                            description: "Procrastination is the enemy of success. Identify one decision you have been putting off. Make it now. Write it down to make it real.",
                            form: `
                                <label class="block text-sm font-medium text-stone-700">The decision I have been avoiding is:</label>
                                <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="e.g., Whether to start the new project, who to hire...">
                                <label class="block text-sm font-medium text-stone-700 mt-4">My decision is:</label>
                                <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="I will...">
                                <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="decision">Mark as Complete & Continue</button>
                            `
                        }
                    },
                    {
                         id: 'persistence',
                         title: 'Persistence: The Sustained Effort to Induce Faith',
                         summary: `Persistence is to character what carbon is to steel. It is the sustained effort necessary to induce faith. The basis of persistence is will-power. When combined with desire, it forms an irresistible force. The story of R.U. Darby and his uncle illustrates the tragedy of quitting. They stopped drilling "three feet from gold." The man who bought their claim hired an engineer, who advised drilling just three feet further, striking one of the richest veins of gold in Colorado. Darby learned his lesson and went on to become a titan of the insurance industry by never again accepting "no" for an answer. <blockquote>"EVERY FAILURE BRINGS WITH IT THE SEED OF AN EQUIVALENT ADVANTAGE."</blockquote>`,
                         practice: {
                             title: "Practice: Persistence Log & Commitment Tracker",
                             description: "Every failure brings with it the seed of an equivalent advantage. Think of a recent 'temporary defeat.' What was the hidden lesson or opportunity? How can you apply it?",
                             form: `<textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="5" placeholder="The setback was... The lesson learned was... My next step is..."></textarea>
                                    <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="persistence">Mark as Complete & Continue</button>`
                         }
                    },
                    {
                         id: 'master-mind',
                         title: 'Power of the Master Mind: The Driving Force',
                         summary: `The "Master Mind" is the coordination of knowledge and effort, in a spirit of harmony, between two or more people, for the attainment of a definite purpose. No individual may have great power without availing himself of the Master Mind. Andrew Carnegie's success was not due to his own knowledge of the steel business, but to his Master Mind group of fifty specialists. Power is required for the accumulation of money, and it is created through organized and intelligently directed knowledge. Hill identifies two phases of the Master Mind: the economic (synergy of skills) and the psychic (the creation of a "third mind" that can tap into Infinite Intelligence). <blockquote>"No two minds ever come together without, thereby, creating a third, invisible, intangible force which may be likened to a third mind."</blockquote>`,
                          practice: {
                             title: "Practice: Master Mind Architect",
                             description: "Who are the people who can provide the knowledge or support you lack? What can you offer them in return? Plan your alliance.",
                              form: `
                                 <label class="block text-sm font-medium text-stone-700">Potential Member 1 (and what I can offer them):</label>
                                 <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="e.g., John Smith (financial expertise). I can offer marketing advice.">
                                 <label class="block text-sm font-medium text-stone-700 mt-4">Potential Member 2 (and what I can offer them):</label>
                                 <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="e.g., Jane Doe (legal counsel). I can offer web design services.">
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="master-mind">Mark as Complete & Continue</button>
                             `
                         }
                    },
                    {
                         id: 'sex-transmutation',
                         title: 'The Mystery of Sex Transmutation',
                         summary: `This principle refers to the modern concept of sublimation: channeling intense emotional energy into productive and creative work. The desire for sexual expression is the most powerful of human desires. When this energy is harnessed and redirected into other channels, it maintains all of its attributes of keenness of imagination, courage, and creative ability. This is a principle of sublimation, not suppression. The most successful people are those with highly developed sex natures who have learned the art of transmuting this powerful energy into creative or business pursuits. <blockquote>"Sex energy is the creative energy of all geniuses. There never has been, and never will be a great leader, builder, or artist lacking in this driving force of sex."</blockquote>`,
                          practice: {
                             title: "Practice: Passion to Project",
                             description: "What are you truly passionate about in life? How can you channel the energy and enthusiasm from that passion into your Definite Chief Aim?",
                              form: `<textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="5" placeholder="My passion is... I can bring that energy to my work by..."></textarea>
                                     <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="sex-transmutation">Mark as Complete & Continue</button>`
                         }
                    },
                    {
                         id: 'subconscious-mind',
                         title: 'The Subconscious Mind: The Connecting Link',
                         summary: `The subconscious mind is a field of consciousness in which every impulse of thought that reaches the objective mind through any of the five senses is classified and recorded. You cannot entirely control your subconscious mind, but you can voluntarily hand over to it any plan, desire, or purpose which you wish transformed into concrete form. To do this, you must learn to speak its language: the language of emotion. You must feed it with positive, emotionalized thoughts and starve the negative ones. <blockquote>Hill identifies 7 Major Positive Emotions: Desire, Faith, Love, Sex, Enthusiasm, Romance, Hope.</blockquote> <blockquote>And 7 Major Negative Emotions to avoid: Fear, Jealousy, Hatred, Revenge, Greed, Superstition, Anger.</blockquote> You cannot have both positive and negative emotions dominating your mind at the same time. One must dominate. It is your responsibility to make sure that positive emotions constitute the dominating influence of your mind.`,
                          practice: {
                             title: "Practice: Positive Emotion Focus",
                             description: "The subconscious responds to emotion. Pick one of the seven major positive emotions and focus on cultivating it today. How can you embody this emotion in your actions?",
                              form: `<textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="5" placeholder="Today I will focus on ENTHUSIASM. I will bring it to my team meeting by..."></textarea>
                                     <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="subconscious-mind">Mark as Complete & Continue</button>`
                         }
                    },
                    {
                         id: 'brain',
                         title: 'The Brain: A Broadcasting and Receiving Station for Thought',
                         summary: `The human brain is both a broadcasting and a receiving station for the vibration of thought. Through the ether, in a fashion similar to radio, every human brain is capable of picking up the vibrations of thought which are being released by other brains. This concept maps to the modern understanding of how our mental state is profoundly influenced by our environment, the people we associate with, and the information we consume. Your "Master Mind" group is your personal broadcasting network. When your mind is attuned to a high rate of vibration (through positive emotions), you are more receptive to thoughts from Infinite Intelligence and your Master Mind. <blockquote>"Every human brain is capable of picking up vibrations of thought which are being released by other brains."</blockquote>`,
                          practice: {
                             title: "Practice: Mental Environment Audit",
                             description: "Your brain 'tunes in' to your surroundings. What is one negative influence (a person, media source, etc.) you can reduce this week? What is one positive influence you can increase?",
                              form: `
                                 <label class="block text-sm font-medium text-stone-700">I will reduce/eliminate:</label>
                                 <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="e.g., Complaining with a coworker">
                                 <label class="block text-sm font-medium text-stone-700 mt-4">I will increase/add:</label>
                                 <input type="text" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" placeholder="e.g., Listening to an inspiring podcast daily">
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="brain">Mark as Complete & Continue</button>
                             `
                         }
                    },
                    {
                         id: 'sixth-sense',
                         title: 'The Sixth Sense: The Door to the Temple of Wisdom',
                         summary: `The "Sixth Sense" is that portion of the subconscious mind which has been referred to as the Creative Imagination. It is the faculty that connects you to Infinite Intelligence. This principle is the apex of the philosophy and can be assimilated and applied only after you have mastered the other twelve principles. Through the sixth sense, you will be warned of impending dangers and notified of opportunities. It is the "guardian angel" that opens the door to the temple of wisdom. Hill describes his method of using his "Invisible Counselors"—an imaginary council of great minds like Lincoln, Emerson, and Edison—as a technique for deliberately engaging this faculty and seeking higher wisdom when faced with a problem. <blockquote>"The Sixth Sense is not something that one can take off and put on at will. Ability to use this great power comes slowly, through application of the other twelve principles."</blockquote>`,
                          practice: {
                             title: "Practice: Intuition Log & Invisible Council",
                             description: "The Sixth Sense often speaks in 'hunches.' Keep a log of these intuitive feelings. Don't judge them, just record them. Over time, you will learn to trust this faculty.",
                              form: `
                                 <label class="block text-sm font-medium text-stone-700">Log a hunch or sudden idea:</label>
                                 <textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="3" placeholder="Today I had a hunch about..."></textarea>
                                 <label class="block text-sm font-medium text-stone-700 mt-4">Consult Your Invisible Council:</label>
                                 <textarea class="mt-1 block w-full rounded-md border-stone-300 shadow-sm" rows="3" placeholder="If I could ask Napoleon, Lincoln, and Carnegie for advice on my current problem, they would tell me to..."></textarea>
                                 <button class="action-button mt-4 px-6 py-2 bg-amber-500 text-white font-bold rounded-lg hover:bg-amber-600" data-action="completePrinciple" data-principle-id="sixth-sense">Mark as Complete & Finish</button>
                             `
                         }
                    }
                 ],
                 fearQuiz: [ /* ... fearQuiz data is unchanged ... */ ],
                 alibis: [ /* ... alibis data is unchanged ... */ ]
            };

            const mainContentArea = document.getElementById('app');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const statusIndicator = document.getElementById('status-indicator');
            const loginOverlay = document.getElementById('login-overlay');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const carouselTrack = document.getElementById('dashboard-carousel-track');
            const carouselDotsContainer = document.getElementById('carousel-dots');
            const prevCarouselBtn = document.getElementById('carousel-prev-btn');
            const nextCarouselBtn = document.getElementById('carousel-next-btn');


            let fearChartInstance = null;
            let currentFearQuizQuestion = 0;
            let fearScores = {};
            
            // --- Firebase Setup (unchanged) ---
            async function setupFirebase() {
                try {
                    const firebaseConfig = {
                        apiKey: "AIzaSyCMeBuLbXz3W23IbfwWU8e-yS7Km8Akeao",
                        authDomain: "think-and-grow-rich-dba8e.firebaseapp.com",
                        projectId: "think-and-grow-rich-dba8e",
                        storageBucket: "think-and-grow-rich-dba8e.appspot.com",
                        messagingSenderId: "164639324890",
                        appId: "1:164639324890:web:e5a281464fd372771f43e3"
                    };
                    
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            document.getElementById('sign-out-btn').classList.remove('hidden');
                            loginOverlay.style.display = 'none';
                            showStatus(`Hi, ${user.displayName.split(' ')[0]}`, false);
                            await loadUserData(userId);
                            setupLoggedInNav();
                            navigate('dashboard');
                        } else {
                            isAuthReady = false;
                            userId = null;
                            userData = null;
                            document.getElementById('sign-out-btn').classList.add('hidden');
                            loginOverlay.style.display = 'flex';
                            showStatus("Not Connected", true);
                            setupLoggedOutNav();
                            navigate('home');
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    showStatus("Connection Failed", true);
                }
            }
            
            async function handleSignOut() { /* ... unchanged ... */ }
            async function handleGoogleLogin() { /* ... unchanged ... */ }
            function showStatus(message, isError) { /* ... unchanged ... */ }
            
            async function loadUserData(uid) {
                if (!db || !uid) return;
                
                const appId = "think-and-grow-rich-workshop";
                const docRef = doc(db, `artifacts/${appId}/users/${uid}/blueprint`, "data");
                
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        userData = docSnap.data();
                        // Ensure completedPrinciples is an array
                        if (!Array.isArray(userData.completedPrinciples)) {
                            userData.completedPrinciples = [];
                        }
                    } else {
                        // Initialize with default structure
                        userData = {
                            desireData: null,
                            faithFormula: '',
                            actionPlan: [],
                            completedPrinciples: []
                        };
                    }
                    renderDashboard(); // This will now render the carousel
                } catch (error) {
                    console.error("Error loading user data:", error);
                    showStatus("Load Failed", true);
                }
            }
            
             async function saveUserData(dataToSave, options = { merge: true }) {
                if (!isAuthReady || !db || !userId) {
                    alert("Not connected. Please sign in.");
                    return;
                }
                showStatus("Saving...", false);
                const appId = "think-and-grow-rich-workshop";
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/blueprint`, "data");
                try {
                    Object.assign(userData, dataToSave);
                    await setDoc(docRef, userData, { merge: true });
                    showStatus("Saved!", false);
                } catch (error) {
                    console.error("Error saving data: ", error);
                    showStatus("Save Failed", true);
                }
            }

            async function markPrincipleAsComplete(principleId) {
                if (!userData.completedPrinciples.includes(principleId)) {
                    userData.completedPrinciples.push(principleId);
                    await saveUserData({ completedPrinciples: userData.completedPrinciples });
                    renderDashboard(); // Re-render to unlock next slide
                    // Move to the next slide automatically
                    const nextIndex = appData.principles.findIndex(p => p.id === principleId) + 1;
                    if (nextIndex < appData.principles.length) {
                        goToCarouselSlide(nextIndex);
                    }
                }
            }
            
            // --- UI and Navigation (Largely unchanged, except renderDashboard) ---
            function setupLoggedInNav() { /* ... unchanged ... */ }
            function setupLoggedOutNav() { /* ... unchanged ... */ }
            function navigate(targetId) { /* ... unchanged ... */ }
            
            // --- MODIFIED & NEW DASHBOARD CAROUSEL LOGIC ---

            function renderDashboard() {
                if (!userData) return;

                const completedCount = userData.completedPrinciples?.length || 0;
                const totalPrinciples = appData.principles.length;

                // Update Header
                document.getElementById('dashboard-progress-summary').innerHTML = `<p class="text-xl font-bold">${completedCount} <span class="text-base font-normal text-stone-600">/ ${totalPrinciples} Principles</span></p>`;
                document.getElementById('dashboard-greeting').innerHTML = `Welcome, ${auth.currentUser.displayName.split(' ')[0]}`;

                // Render Carousel
                renderDashboardCarousel();
                
                // Set initial slide position
                // Go to the first incomplete principle
                currentCarouselIndex = completedCount;
                if (currentCarouselIndex >= totalPrinciples) {
                    currentCarouselIndex = totalPrinciples - 1; // Go to last slide if all are complete
                }
                goToCarouselSlide(currentCarouselIndex);
            }

            function getPracticeHtmlForPrinciple(principleId, isCompleted, isLocked) {
                const principle = appData.content.find(p => p.id === principleId);
                if (!principle || !principle.practice) return '<p>No practice exercise for this principle.</p>';

                if (isLocked) {
                     return `<div class="text-center p-8">
                                <svg class="mx-auto h-12 w-12 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                <h4 class="mt-2 text-xl font-bold text-stone-600">Locked</h4>
                                <p class="mt-1 text-stone-500">Complete the previous principle to unlock this exercise.</p>
                             </div>`;
                }

                if (isCompleted) {
                    return `<div class="text-center p-8">
                                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                <h4 class="mt-2 text-xl font-bold text-green-600">Principle Mastered!</h4>
                                <p class="mt-1 text-stone-500">You have completed this exercise. You can review or modify it from the main 'Principles' section if needed.</p>
                             </div>`;
                }

                // If it's the current, unlocked, incomplete principle
                let practiceContent = '';
                if (principle.practice.buttonText) {
                     practiceContent = `<button class="action-button bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300" data-action="${principle.practice.action}" data-principle-id="${principle.id}">${principle.practice.buttonText}</button>`;
                } else {
                     practiceContent = principle.practice.form || '';
                }

                return `<div class="p-4 sm:p-6">
                            <h3 class="text-xl font-bold text-amber-500 mb-2">${principle.practice.title}</h3>
                            <p class="text-stone-600 mb-4">${principle.practice.description}</p>
                            <div id="practice-form-area-${principle.id}">${practiceContent}</div>
                         </div>`;
            }

            function renderDashboardCarousel() {
                carouselTrack.innerHTML = '';
                carouselDotsContainer.innerHTML = '';
                const completedCount = userData.completedPrinciples?.length || 0;

                appData.principles.forEach((p, index) => {
                    const isCompleted = userData.completedPrinciples.includes(p.id);
                    const isLocked = index > completedCount;

                    // Create Slide
                    const slide = document.createElement('div');
                    slide.className = 'carousel-slide';
                    slide.innerHTML = `
                        <div class="bg-stone-50 rounded-lg min-h-[400px] flex flex-col justify-between">
                            <div class="p-4 border-b border-stone-200">
                                <h3 class="text-2xl font-bold text-stone-800">Principle ${index + 1}: ${p.name}</h3>
                                <p class="text-stone-500 font-serif">${p.tagline}</p>
                            </div>
                            <div class="flex-grow flex items-center justify-center ${isLocked ? 'locked' : ''}">
                                ${getPracticeHtmlForPrinciple(p.id, isCompleted, isLocked)}
                            </div>
                        </div>`;
                    carouselTrack.appendChild(slide);

                    // Create Dot
                    const dot = document.createElement('button');
                    dot.className = `carousel-dot ${isLocked ? 'locked' : ''}`;
                    dot.dataset.index = index;
                    if(isLocked) dot.disabled = true;
                    carouselDotsContainer.appendChild(dot);
                });
                
                // Add event listeners for dynamic content
                document.getElementById('practice-form-area-faith')?.querySelector('button')?.addEventListener('click', handleSaveFaithFormula);
                if (document.getElementById('action-plan-container')) {
                    renderActionPlan();
                    renderLeadershipSliders();
                }
            }
            
            function goToCarouselSlide(index) {
                if (index < 0 || index >= appData.principles.length) return;
                
                currentCarouselIndex = index;
                carouselTrack.style.transform = `translateX(-${index * 100}%)`;

                // Update dots
                document.querySelectorAll('.carousel-dot').forEach((dot, dotIndex) => {
                    dot.classList.toggle('active', dotIndex === index);
                });

                // Update buttons
                prevCarouselBtn.disabled = index === 0;
                const completedCount = userData.completedPrinciples?.length || 0;
                nextCarouselBtn.disabled = index >= appData.principles.length - 1 || index >= completedCount;
            }


            // --- Interactive Exercises ---
            function handleSaveFaithFormula() { /* ... Modified to fit carousel flow ... */
                const formulaText = document.getElementById('faith-formula').value;
                if (!formulaText) {
                    alert('Please write your Self-Confidence Formula.');
                    return;
                }
                markPrincipleAsComplete('faith');
                saveUserData({ faithFormula: formulaText });
                alert('Your Self-Confidence Formula has been saved!');
            }
            
            function renderPrincipleGrid() { /* ... unchanged ... */ }
            function renderPrincipleDetail(principleId, forceShowForm = false) { /* ... unchanged ... */ }
            function handleModify(principleId) { /* ... unchanged ... */ }
            function openDesireModal() { /* ... unchanged ... */ }
            function closeDesireModal() { /* ... unchanged ... */ }
            function closeResetModal() { /* ... unchanged ... */ }
            
            async function handleDesireFormSubmit(e) {
                e.preventDefault();
                const desireData = {
                    amount: document.getElementById('desire-amount').value,
                    give: document.getElementById('desire-give').value,
                    date: document.getElementById('desire-date').value,
                    plan: document.getElementById('desire-plan').value,
                };

                if (!desireData.amount || !desireData.give || !desireData.date || !desireData.plan) {
                    alert('Please fill out all fields to create your statement.');
                    return;
                }
                
                closeDesireModal();
                await saveUserData({ desireData: desireData, desireStatement: null });
                await markPrincipleAsComplete('desire');
                alert('Your Desire Statement has been saved!');
            }
            
            
            // --- App Initialization ---
            function initStaticContent() {
                
                // ... (init of sidebar, workshop tools etc. is unchanged)

                mainContentArea.addEventListener('click', e => {
                    const navButton = e.target.closest('.nav-button');
                    const actionButton = e.target.closest('.action-button');
                    
                    if (navButton && navButton.dataset.target) {
                        e.preventDefault();
                        navigate(navButton.dataset.target);
                    }
                    
                    if (actionButton) {
                        e.preventDefault();
                        const action = actionButton.dataset.action;
                        const principleId = actionButton.dataset.principleId;
                        if (action === 'openDesireModal') openDesireModal();
                        // Note: saveFaith is handled inside renderDashboardCarousel now
                        if (action === 'completePrinciple') {
                            markPrincipleAsComplete(principleId);
                        }
                    }

                    if (e.target.id === 'add-task-btn') {
                        handleAddTask();
                    }
                });
                
                // Carousel Navigation
                prevCarouselBtn.addEventListener('click', () => goToCarouselSlide(currentCarouselIndex - 1));
                nextCarouselBtn.addEventListener('click', () => goToCarouselSlide(currentCarouselIndex + 1));
                carouselDotsContainer.addEventListener('click', e => {
                    if(e.target.matches('.carousel-dot') && !e.target.disabled) {
                        goToCarouselSlide(parseInt(e.target.dataset.index));
                    }
                });

                document.getElementById('desire-form').addEventListener('submit', handleDesireFormSubmit);
                document.getElementById('close-desire-modal').addEventListener('click', closeDesireModal);
                
                // ... (other event listeners are unchanged)
                
                googleLoginBtn.addEventListener('click', handleGoogleLogin);
                document.getElementById('sign-out-btn').addEventListener('click', handleSignOut);
                mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
            }
            
            // --- Run App ---
            initStaticContent();
            setupFirebase();

        });
    </script>
</body>
</html>
